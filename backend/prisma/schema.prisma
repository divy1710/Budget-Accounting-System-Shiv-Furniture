// Shiv Furniture - Budget Accounting System
// Complete Database Schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum ContactType {
    CUSTOMER
    VENDOR
}

enum TransactionType {
    PURCHASE_ORDER
    VENDOR_BILL
    SALES_ORDER
    CUSTOMER_INVOICE
}

enum TransactionStatus {
    DRAFT
    CONFIRMED
    CANCELLED
}

enum PaymentStatus {
    NOT_PAID
    PARTIALLY_PAID
    PAID
}

enum PaymentType {
    SEND
    RECEIVE
}

enum PaymentRecordStatus {
    DRAFT
    CONFIRMED
    CANCELLED
}

enum BudgetStatus {
    DRAFT
    CONFIRMED
    REVISED
    ARCHIVED
}

enum BudgetLineType {
    INCOME
    EXPENSE
}

// ===================== USERS =====================

model User {
    id        Int      @id @default(autoincrement())
    loginId   String   @unique
    email     String   @unique
    name      String
    password  String
    role      String   @default("portal") // admin, portal
    isActive  Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// ===================== MASTER DATA =====================

// Customers and Vendors
model Contact {
    id       Int         @id @default(autoincrement())
    name     String
    email    String?
    phone    String?
    jobTitle String?
    type     ContactType
    isActive Boolean     @default(true)

    // Address fields
    street  String?
    city    String?
    state   String?
    country String?
    pincode String?

    // Image
    imageUrl String?

    // Tags (comma-separated: B2B, MSME, Retailer, Local)
    tags String?

    // Portal access for customers
    isPortalUser   Boolean @default(false)
    portalPassword String?

    // Relations
    vendorTransactions   Transaction[]         @relation("VendorTransactions")
    customerTransactions Transaction[]         @relation("CustomerTransactions")
    payments             Payment[]
    autoAnalyticalRules  AutoAnalyticalModel[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// Product Categories
model Category {
    id                  Int                   @id @default(autoincrement())
    name                String                @unique
    isActive            Boolean               @default(true)
    products            Product[]
    autoAnalyticalRules AutoAnalyticalModel[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// Products/Items
model Product {
    id            Int       @id @default(autoincrement())
    name          String
    categoryId    Int?
    category      Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
    salesPrice    Decimal   @default(0) @db.Decimal(10, 2)
    purchasePrice Decimal   @default(0) @db.Decimal(10, 2)
    isActive      Boolean   @default(true)

    // Relations
    transactionLines    TransactionLine[]
    autoAnalyticalRules AutoAnalyticalModel[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// Analytical Accounts (Cost Centers) - Hierarchical
model AnalyticalAccount {
    id          Int     @id @default(autoincrement())
    code        String  @unique
    name        String
    description String?

    // Hierarchy
    parentId Int?
    parent   AnalyticalAccount?  @relation("AccountHierarchy", fields: [parentId], references: [id])
    children AnalyticalAccount[] @relation("AccountHierarchy")

    // Relations
    budgetLines         BudgetLine[]
    transactionLines    TransactionLine[]
    autoAnalyticalRules AutoAnalyticalModel[]

    isActive  Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// Budget Master - Header for a budget period
model BudgetMaster {
    id        Int          @id @default(autoincrement())
    name      String // e.g., "January 2026", "Q1 2026"
    startDate DateTime
    endDate   DateTime
    status    BudgetStatus @default(DRAFT)

    // Revision tracking
    revisedFromId Int?
    revisedFrom   BudgetMaster?  @relation("BudgetRevisions", fields: [revisedFromId], references: [id])
    revisedTo     BudgetMaster[] @relation("BudgetRevisions")

    // Relations
    lines BudgetLine[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// Budget Line - Individual budget entries per analytical account
model BudgetLine {
    id       Int            @id @default(autoincrement())
    budgetId Int
    budget   BudgetMaster   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
    type     BudgetLineType // INCOME or EXPENSE

    analyticalAccountId Int
    analyticalAccount   AnalyticalAccount @relation(fields: [analyticalAccountId], references: [id])

    budgetedAmount Decimal @default(0) @db.Decimal(15, 2)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([budgetId, analyticalAccountId, type])
}

// Auto-assignment rules for Analytical Accounts
model AutoAnalyticalModel {
    id          Int     @id @default(autoincrement())
    name        String?
    description String?
    status      String  @default("DRAFT") // DRAFT, CONFIRMED, CANCELLED

    // Match criteria - Partner Tag and Partner
    partnerTag String? // Tag to match (B2B, MSME, Retailer, Local)
    partnerId  Int?
    partner    Contact? @relation(fields: [partnerId], references: [id])

    // Match criteria - Product Category and Product
    categoryId Int?
    category   Category? @relation(fields: [categoryId], references: [id])
    productId  Int?
    product    Product?  @relation(fields: [productId], references: [id])

    // Target analytical account
    analyticalAccountId Int
    analyticalAccount   AnalyticalAccount @relation(fields: [analyticalAccountId], references: [id])

    priority  Int      @default(0) // Higher = checked first (more matches = higher priority)
    isActive  Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// ===================== TRANSACTIONS =====================

// PO, Vendor Bill, SO, Customer Invoice
model Transaction {
    id                String            @id @default(cuid())
    transactionNumber String            @unique
    type              TransactionType
    status            TransactionStatus @default(DRAFT)
    paymentStatus     PaymentStatus     @default(NOT_PAID)

    // Contact reference
    vendorId   Int?
    vendor     Contact? @relation("VendorTransactions", fields: [vendorId], references: [id])
    customerId Int?
    customer   Contact? @relation("CustomerTransactions", fields: [customerId], references: [id])

    // Reference number (user input, e.g., REQ-25-0001)
    reference String?

    // Dates
    transactionDate DateTime  @default(now())
    dueDate         DateTime?

    // Amounts
    subtotal    Decimal @default(0) @db.Decimal(15, 2)
    taxAmount   Decimal @default(0) @db.Decimal(15, 2)
    totalAmount Decimal @default(0) @db.Decimal(15, 2)
    paidAmount  Decimal @default(0) @db.Decimal(15, 2)

    // Link to parent transaction (PO→Bill, SO→Invoice)
    parentId          String?
    parentTransaction Transaction?  @relation("TransactionParent", fields: [parentId], references: [id])
    childTransactions Transaction[] @relation("TransactionParent")

    notes String?

    // Relations
    lines              TransactionLine[]
    paymentAllocations PaymentAllocation[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// Transaction Line Items
model TransactionLine {
    id            Int         @id @default(autoincrement())
    transactionId String
    transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

    productId Int
    product   Product @relation(fields: [productId], references: [id])

    description String?
    quantity    Decimal @db.Decimal(10, 2)
    unitPrice   Decimal @db.Decimal(10, 2)
    gstRate     Decimal @default(18) @db.Decimal(5, 2)
    lineTotal   Decimal @db.Decimal(15, 2)

    // Analytical Account for budget tracking
    analyticalAccountId Int?
    analyticalAccount   AnalyticalAccount? @relation(fields: [analyticalAccountId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// ===================== PAYMENTS =====================

// Payment Records
model Payment {
    id            Int                 @id @default(autoincrement())
    paymentNumber String              @unique
    paymentDate   DateTime            @default(now())
    amount        Decimal             @db.Decimal(15, 2)
    status        PaymentRecordStatus @default(DRAFT)
    paymentType   PaymentType         @default(SEND) // SEND = outgoing to vendor, RECEIVE = incoming from customer

    paymentMethod String // cash, bank, upi, card
    reference     String? // Bank ref, UPI ID, etc.

    // Contact reference
    contactId Int
    contact   Contact @relation(fields: [contactId], references: [id])

    // Link to source transaction (Bill or Invoice)
    sourceTransactionId String?

    notes String?

    // Relations
    allocations PaymentAllocation[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// Payment allocation to transactions
model PaymentAllocation {
    id            Int         @id @default(autoincrement())
    paymentId     Int
    payment       Payment     @relation(fields: [paymentId], references: [id], onDelete: Cascade)
    transactionId String
    transaction   Transaction @relation(fields: [transactionId], references: [id])

    allocatedAmount Decimal @db.Decimal(15, 2)

    createdAt DateTime @default(now())
}
